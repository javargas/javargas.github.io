<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Open+Sans');
</style>
<style>

    .login_module {
      margin-top: 100px;
      background-color: #FFFFFF;
    }

    @media (max-width: 460px) {
        .login_module{
            width: 280px;
        }

        .input-icon {
            left: 253px;
        }
    }

    @media (min-width: 460px)  and (max-width: 1024px) {
        .login_module {
            width: 460px;
        }

        .input-icon {
            left: 433px;
        }
    }

    @media (min-width: 1024px) {
        .login_module{
            width: 570px;
        }

        .input-icon {
            left: 543px;
        }
    }
    
    #login_text_1 {
        left: 355px;
        display: block;
        height: 38px;
        font-family: Spectral;
        font-style: normal;
        font-weight: bold;
        font-size: 30px;
        margin-top: 50px;
        line-height: 38px;
        text-align: center;
        color: #36393D;
    }
    
    .login_errors {
        font-family: Open Sans;
        font-style: normal;
        font-weight: normal;
        font-size: 13px;
        line-height: 18px;
        color: #B63125;
    }
    
    #login_text_2 {
        height: 26px;
        display: block;
        font-family: Open Sans;
        font-style: normal;
        font-weight: normal;
        margin-top: 20px;
        font-size: 18px;
        line-height: 26px;
        text-align: center;
        color: #60666C;
    }
    
    .login_input {
        width: 100%;
        height: 60px;  display: block;
        background: #F9F9F9;
        border: 1px solid #9BA1B3;
        box-sizing: border-box;
        box-shadow: inset 0px 1px 4px rgba(0, 0, 0, 0.2);
        margin-top: 20px;
        border-radius: 4px;
        font-family: Open Sans;
        font-style: normal;
        font-weight: normal;
        font-size: 16px;
        line-height: 24px;
        color: #36393D;
        opacity: 0.6;
        margin-bottom: 6px;
    }
    .input-wrapper{
        position: relative;
    }
    
    .input-icon{
        position: absolute;
      	cursor: pointer;
        opacity: 0.6;
        top: calc(50% - 1.8em); /* Keep icon in center of input, regardless of the input height */
    }
    
    .login_password {
        padding-right: 17px;
    }
    
    #divPassword {
        display: none;
    }
    
    .login_button {
        width: 100%;
        height: 60px;
        background-color: #004E87;
        border-radius: 4px;font-family: Open Sans;
        font-style: normal;
        font-size: 18px;
        line-height: 24px;
        margin-top: 20px;
        margin-bottom: 20px;
        text-align: center;
        color: #FFFFFF !important;
    
    }
  .pwd_pass {
  		font-size: 16px;
    	color: #7cba61;
    	display: block;
    	font-family: 'Open Sans';
  }
  .pwd_error {
  		font-size: 16px;
    	color: #ff0000;
    	display: block;
    	font-family: 'Open Sans';
      text-align: left;
  }
  
  .emailError{
  	color: #ff0000;
    font-size: 16px;
    color: #ff0000;
    display: block;
    margin-top: 10px;
    font-family: 'Open Sans';
    text-align: left;
  }

/* Just for demo */

.title {
  font-size: 24px;
  margin: 8px;
}

.actions {
  width: 100%;
  margin: 16px;
  text-align: justify;
}

.actions > button {
  width: 33%;
  margin: 0 8px;
}
  .elepos {
    position: absolute;
    left: 2px;
    padding-top: 3px;
}
  #error_messages{
  	padding-left:20px;
    margin-top: 10px;
    text-align: left;
  }
  .login_button{
  	background-color: #004E87 !important;
  }
  .error_border{
  	border: 1px solid #B63125;
  }
  .error-block {
    width: 100%;
    background: rgba(182, 49, 37, 0.12);
    border: 1px solid #B63125;
    box-sizing: border-box;
    border-radius: 4px;
    padding: 0 8px 8px 8px;
    display: flex;
    align-items: baseline;
    text-align: left;
}

.icon-block{
    flex: 5%;
}

.message-block {
    flex: 95%;
}

.error-icon {
    color: red;
    font-size: 18px;
}
.dnone {
    display:none;
}
  .user-block {
    font-size: 15px;
    margin-top: 40px;
    color: #60666C;
    text-align: left;
}

.loggedUserDetail{
    margin-top: -9px;
    font-weight: 800;
    color: #000;
}
    </style>
    <div class="login_module center" id='${planBlockId}'>
        <div id="login_text_1">
        Let's start with your email
        </div>
        
        <div id="login_text_2">
        This will be used to log in to our website and app. 
        </div>
        <fieldset id="userEmailField">
        <input type="text" 
               class="login_input" 
               placeholder="Email address"
               id="login_email"
               onfocus="removeError()"
                 />
          <span class="emailError" id="emailErrorInfo"></span>
    	<legend><label for="username">Email address</label></legend>
 </fieldset>
        <span class="pwd_error" id="login_error"><i class="fa fa-exclamation-circle" aria-hidden="true"></i>Enter a valid email address</span>
    	<div id="user-block" class="user-block dnone">
          <p>You're logged in as</p>
          <p id="loggedUserDetail" class="loggedUserDetail"></p>
      </div>
      <div id="error-block" class="error-block dnone">
            <div class="icon-block">
                <i class="error-icon fa fa-exclamation-circle" aria-hidden="true"></i>
            </div>
            <div class="message-block">
                <span class="emailError" id="service_error">
                    
                </span>
            </div>
        </div>
        <div class="input-wrapper" id="divPassword">
          
          <fieldset>
            <input  type="password"
                    class="login_input login_password"
                    placeholder="Password"
                    id="password"
                    onkeyup="validatePass()"
                    required />
    		<legend><label for="username">Password</label></legend>
                <label for="password" id="eyePwd" onClick="toogleEye()"
                    class="fa input-icon fa-eye-slash">
                </label>
            
 </fieldset>	<div id="error_messages">
          		<span class="pwd_pass" id="minLength"><i id="error_ml" class="elepos fa fa-exclamation-circle" aria-hidden="true"></i>Minimum length is 6</span>
                <span class="pwd_pass" id="reqLetter"><i id="error_rl" class="elepos fa fa-exclamation-circle" aria-hidden="true"></i>Include at least 1 letter</span>
                <span class="pwd_pass" id="reqNumber"><i id="error_rn" class="elepos fa fa-exclamation-circle" aria-hidden="true"></i>Include at least 1 number</span>
          </div>
        </div>
      	<span class="emailError" id="service_error2"></span>
                
        <input type="button" class="login_button" value="Continue" onClick="submitLogin()">
        <input type="hidden" id="isNewUser" name="isNewUser" value="0">
    </div>
    <script>
      setTimeout(function(){ 
      	var loggedInUser = trb.data.user.email;
        document.getElementById("login_error").style.display = "none";
        //var loginData = recDssState.getData("login");
        if (loggedInUser != null) {
          document.getElementById("login_email").value = loggedInUser;
          document.getElementById("login_text_1").innerHTML = "${welcome_msg}";
          document.getElementById("login_text_2").innerHTML = "${welcome_msg2}";
        }
      }, 0);
      
      let validPassword = false;
      let btnContinueEnable = true;
      document.getElementById("error_ml").style.display = "none";
      document.getElementById("error_rl").style.display = "none";
      document.getElementById("error_rn").style.display = "none";

function submitLogin() {
    if(btnContinueEnable){
        recDssState.nextStep();
    }
}
      
function toogleEye(){
	var eyePwd = document.getElementById("eyePwd");
	var password = document.getElementById("password");
	if (eyePwd.classList.contains('fa-eye-slash')) {
		eyePwd.classList.remove('fa-eye-slash');
		eyePwd.classList.add('fa-eye');

		password.type = 'text';
    } else {
		eyePwd.classList.remove('fa-eye');
		eyePwd.classList.add('fa-eye-slash');

		password.type = 'password';
	}
}
      
function removeError(){
  document.getElementById("login_email").classList.remove('error_border');
  document.getElementById("login_error").style.display = "none";
}
      
function validatePass(){
  let userPwd = document.getElementById('password');
  var minLength = document.getElementById("minLength");
  var reqLetter = document.getElementById("reqLetter");
  var reqNumber = document.getElementById("reqNumber");
  var caseLetters = /[a-zA-Z]/;
  var caseNumbers = /[0-9]/g;
  if(userPwd.value.match(caseLetters)) {
    document.getElementById("error_rl").style.display = "none";
    reqLetter.classList.remove("pwd_error");
    reqLetter.classList.add("pwd_pass");
  } else {
    document.getElementById("error_rl").style.display = "block";
    reqLetter.classList.remove("pwd_pass");
    reqLetter.classList.add("pwd_error");
  }
  if(userPwd.value.match(caseNumbers)) {
    document.getElementById("error_rn").style.display = "none";
    reqNumber.classList.remove("pwd_error");
    reqNumber.classList.add("pwd_pass");
  } else {
    document.getElementById("error_rn").style.display = "block";
    reqNumber.classList.remove("pwd_pass");
    reqNumber.classList.add("pwd_error");
  }
  if(userPwd.value.length >= 6) {
    document.getElementById("error_ml").style.display = "none";
    minLength.classList.remove("pwd_error");
    minLength.classList.add("pwd_pass");
  } else {
    document.getElementById("error_ml").style.display = "block";
    minLength.classList.remove("pwd_pass");
    minLength.classList.add("pwd_error");
  }
  if(userPwd.value.match(caseLetters) && userPwd.value.match(caseNumbers) && userPwd.value.length >= 6){
  	validPassword = true;
  }
}
      
function existedUser(){
	document.getElementById('divPassword').style.display = 'none';
    document.getElementById("login_text_1").innerHTML = "${welcome_msg}";
    document.getElementById("login_text_2").innerHTML = "${userExistMsg}";
  	document.getElementById('error-block').style.display = 'none';
  	
}

function setState(){
	let marketCode = recDssState.getData('params').market;
    recDssState.setData("current_market",  {
      code : marketCode,
      name : recDssState.getData('markets')[marketCode].name
    });
	recDssState.setData('login', null );
  	recDssState.setData('ssor_id', null );
}
      
(() => {
  
  let blnGoToPayment = false;
  let ExistedUser = false;
  setState();
  async function validateEmail(){
    console.log("Validating email");
	  
      let email = document.getElementById('login_email').value;
      if ( /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(email)){
          /* Registering data in global recDssState */
          recDssState.setData("login",  {
                  email : email
          });
          // Simulating that user exists
          document.getElementById("isNewUser").value = 1;
        	var loc = location;
        	var stage = ~loc.hostname.indexOf('stage');
        	var host = stage ? '.stage.int.tribops.com' : '.tribdss.com';
        
          var userExistCheck = {
            "url": "https://ssor.p2p" + host + "/consumers/user_exists",
            "method": "GET",

            "data": {
              "email": email
            },
            "async": false
          };
          
        
          let userExistCheckCall = trb.registration.utils.page.userExist(userExistCheck);
          
          var validationError = true;
            if(userExistCheckCall.exists){
                validationError = false;
            	recDssState.setData("ssor_id",  {
                  ssor_id: userExistCheckCall.ssor_id,
                  enc_ssor_id : userExistCheckCall.enc_ssor_id
          		});
              	var userSystem = {
                  "url": "https://dss.p2p" + host + "/subscriptions/user/systemcheck/ctc",
                  "method": "GET",

                  "data": {
                    "ssor_id": userExistCheckCall.enc_ssor_id
                  },
                  "async": false
                };
                let accountCheckResponse = trb.registration.utils.page.userSystemCheck(userSystem);
              	
              	var errorMessage = "";
              	if(accountCheckResponse.ssor_response_code == 0){
                  	errorMessage = "${serviceDown}";
                    btnContinueEnable = false;
                } else if(accountCheckResponse.ssor_response_code == 2){
                  	validationError = true;
                } else if(accountCheckResponse.ssor_response_code == 1){
                    if(accountCheckResponse.mg2_response_code == 0 && accountCheckResponse.recurly_response_code == 0){
                        errorMessage = "${serviceDown}";
                        btnContinueEnable = false;
                    }else if(accountCheckResponse.mg2_response_code == 0 && accountCheckResponse.recurly_response_code == 1){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Login <a href='${recurlyLoginLink}'>here</a> or Reset your password <a href='${recurlyResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 0 && accountCheckResponse.recurly_response_code == 2){
                        btnContinueEnable = false;
                      	errorMessage = "${serviceDown}";
                    }else if(accountCheckResponse.mg2_response_code == 1 && accountCheckResponse.recurly_response_code == 0){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Login <a href='${mg2LoginLink}'>here</a> or Reset your password <a href='${mg2ResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 1 && accountCheckResponse.recurly_response_code == 1){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Login <a href='${recurlyLoginLink}'>here</a> or Reset your password <a href='${recurlyResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 1 && accountCheckResponse.recurly_response_code == 2){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Login <a href='${mg2LoginLink}'>here</a> or Reset your password <a href='${mg2ResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 2 && accountCheckResponse.recurly_response_code == 0){
                        errorMessage = "${serviceDown}";
                        btnContinueEnable = false;
                    }else if(accountCheckResponse.mg2_response_code == 2 && accountCheckResponse.recurly_response_code == 1){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Login <a href='${recurlyLoginLink}'>here</a> or Reset your password <a href='${recurlyResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 2 && accountCheckResponse.recurly_response_code == 2){
                        blnGoToPayment = true;
                      	validationError = true;
                      	ExistedUser = true;
                    }
                }
                document.getElementById('service_error2').innerHTML = errorMessage;
            } else {
            	return true;
            }

          // return true;
          return validationError;
      }
	  document.getElementById("login_email").classList.add('error_border');
      document.getElementById("login_error").style.display = "block";
      return false;
  }
  
  
   recDssState.subscribe((step) => {
       let isNewUser = parseInt(document.getElementById("isNewUser").value);
        if (step == ${step_authenticate}) {
          
          if(ExistedUser){
            document.getElementById('divPassword').style.display = 'none';
            document.getElementById("login_text_1").innerHTML = "${welcome_msg}";
          	document.getElementById("login_text_2").innerHTML = "${userExistMsg}";
          	return;
          }
          
          if (trb.data.user.email != null) {
            var loc = location;
        	var stage = ~loc.hostname.indexOf('stage');
            var host = stage ? '.stage.int.tribops.com' : '.tribdss.com';

            var userExistCheck = {
              "url": "https://ssor.p2p" + host + "/consumers/user_exists",
              "method": "GET",

              "data": {
                "email": trb.data.user.email
              },
              "async": false
            };


            let userExistCheckCall = trb.registration.utils.page.userExist(userExistCheck);
            if(userExistCheckCall.exists){
              	
                recDssState.setData("login",  {
                      email : trb.data.user.email
              });
            	recDssState.setData("ssor_id",  {
                  ssor_id: userExistCheckCall.ssor_id,
                  enc_ssor_id : userExistCheckCall.enc_ssor_id
          		});
              	var userSystem = {
                  "url": "https://dss.p2p" + host + "/subscriptions/user/systemcheck/ctc",
                  "method": "GET",

                  "data": {
                    "ssor_id": userExistCheckCall.enc_ssor_id
                  },
                  "async": false
                };
              let accountCheckResponse = trb.registration.utils.page.userSystemCheck(userSystem);
              var errorMessage = "";
              	if(accountCheckResponse.ssor_response_code == 0){
                    errorMessage = "${serviceDown}";
                    btnContinueEnable = false;
                } else if(accountCheckResponse.ssor_response_code == 2){
                    validationError = true;
                } else if(accountCheckResponse.ssor_response_code == 1){
                  	document.getElementById('userEmailField').style.display = "none";
                    if(accountCheckResponse.mg2_response_code == 0 && accountCheckResponse.recurly_response_code == 0){
                        errorMessage = "${serviceDown}";
                        btnContinueEnable = false;
                    }else if(accountCheckResponse.mg2_response_code == 0 && accountCheckResponse.recurly_response_code == 1){
                        errorMessage = "${recurlyExistMessage}" + "Manage your subscription <a href='${recurlyLoginLink}'>here</a> or Reset your password <a href='${recurlyResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 0 && accountCheckResponse.recurly_response_code == 2){
                        errorMessage = "${serviceDown}";
                        btnContinueEnable = false;
                    }else if(accountCheckResponse.mg2_response_code == 1 && accountCheckResponse.recurly_response_code == 0){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Manage your subscription <a href='${mg2LoginLink}'>here</a> or Reset your password <a href='${mg2ResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 1 && accountCheckResponse.recurly_response_code == 1){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Manage your subscription <a href='${recurlyLoginLink}'>here</a> or Reset your password <a href='${recurlyResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 1 && accountCheckResponse.recurly_response_code == 2){
                        ExistedUser = true;
                      	errorMessage = "${recurlyExistMessage}" + "Manage your subscription <a href='${mg2LoginLink}'>here</a> or Reset your password <a href='${mg2ResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 2 && accountCheckResponse.recurly_response_code == 0){
                        errorMessage = "${serviceDown}";
                        btnContinueEnable = false;
                    }else if(accountCheckResponse.mg2_response_code == 2 && accountCheckResponse.recurly_response_code == 1){
                        btnContinueEnable = false;
                      	errorMessage = "${recurlyExistMessage}" + "Manage your subscription <a href='${recurlyLoginLink}'>here</a> or Reset your password <a href='${recurlyResetLink}'>here.</a>";
                    }else if(accountCheckResponse.mg2_response_code == 2 && accountCheckResponse.recurly_response_code == 2){
                        blnGoToPayment = true;
                      	validationError = true;
                      	ExistedUser = true;
                      	existedUser();
                    }
                }
                document.getElementById("user-block").classList.remove('dnone');
                document.getElementById("error-block").classList.remove('dnone');
              	document.getElementById('loggedUserDetail').innerHTML = trb.data.user.email;
                document.getElementById('service_error').innerHTML = errorMessage;
            }
            return;
          }
          if (blnGoToPayment) {
              console.log("Go to Payment");
              recDssState.addValidator(${step_authenticate}, async ()=>{ return true; });
              recDssState.nextStep();
              return;
          }
          
          if (isNewUser) {
              // adding registerUser
              recDssState.addValidator(step, async function(){
                  console.log("Registering user");
                  var userDetails = {
                  "url": "https://ssor.p2p.stage.int.tribops.com/consumers/create_user",
                  "method": "POST",
				  "async": false,
                  "data": {
                    "email": document.getElementById('login_email').value,
                    "password": document.getElementById('password').value,
                    "product_code": "dss_default",
                    "host_url": "https://tribune.ssor.stage.trbdevcloud.com"
                  },
                };
				let createdUser = trb.registration.utils.page.createUser(userDetails);
                //$.ajax(userDetails).done(function (response)
				if(createdUser.success){
                //{  
                  	recDssState.setData("ssor_id",  {
                      ssor_id: createdUser.masterId,
                      enc_ssor_id : createdUser.encryptedMasterId
                    });
                }
                //});
                  return true;
              });
          } else {
              recDssState.addValidator(step, async () => {
                  console.log("Validating password");
                  return validPassword;
              });
          }
      
          document.getElementById('divPassword').style.display = 'inherit';
          let userPwd = document.getElementById('password').value;
        }

        if (step == ${step_payment}) {
            document.getElementById('${planBlockId}').style.display = 'none';
        }

        console.log("Execute action from module.");
    });
  
  if (trb.data.user.email == null) {
    console.log('Adding first step validation for email');
  	recDssState.addValidator(${step_validate_email}, validateEmail);
  } else {
  	 recDssState.nextStep();
     console.log('console after next step');
  }
  
})();  
    </script>